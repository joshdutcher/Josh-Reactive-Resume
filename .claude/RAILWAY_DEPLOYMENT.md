# Railway Deployment Guide - Josh's Reactive Resume

## Important: Railway-Only Deployment

⚠️ **This fork is specifically configured for Railway deployment.** While the upstream Reactive Resume supports various deployment methods (Docker, Vercel, Netlify, etc.), this custom fork includes Railway-specific configurations, service architectures, and environment variables that may not work on other platforms without modification.

**If you need to deploy on another platform**, refer to the [upstream documentation](https://docs.rxresu.me) and adapt the configurations accordingly.

## Railway Architecture Overview

This deployment consists of **4 interconnected Railway services**:

```
┌─────────────────────────────────────────────────────────────┐
│                     Railway Project                          │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────┐      ┌──────────────────┐            │
│  │   PostgreSQL     │◄─────┤ Reactive Resume  │            │
│  │   (Database)     │      │  (Main App)      │            │
│  └──────────────────┘      └────────┬─────────┘            │
│                                      │                       │
│  ┌──────────────────┐              │                       │
│  │     MinIO        │◄──────────────┤                       │
│  │   (Storage)      │               │                       │
│  └──────────────────┘              │                       │
│                                      │                       │
│  ┌──────────────────┐              │                       │
│  │   Browserless    │◄──────────────┘                       │
│  │  (PDF Renderer)  │                                       │
│  └──────────────────┘                                       │
│                                                               │
└─────────────────────────────────────────────────────────────┘

External Access:
├── Public: Reactive Resume (HTTPS)
├── Public: MinIO (HTTPS, public bucket access)
├── Internal: PostgreSQL (private, Railway network only)
└── Internal: Browserless (private, Railway network only)
```

## Service Configuration

### 1. PostgreSQL Database

**Service Type**: Railway PostgreSQL Template
**Access**: Private (Railway internal network only)
**Pricing**: Included in Railway plan

**Setup**:
1. In Railway dashboard, click "New" → "Database" → "Add PostgreSQL"
2. Railway automatically provisions and connects the database
3. Connection string available as `DATABASE_URL` environment variable

**Configuration**:
- No manual configuration required
- Automatic backups managed by Railway
- Connection pooling handled by Railway

**Environment Variables** (auto-generated):
```bash
DATABASE_URL=postgresql://postgres:password@postgres.railway.internal:5432/railway
PGHOST=postgres.railway.internal
PGPORT=5432
PGUSER=postgres
PGPASSWORD=<auto-generated>
PGDATABASE=railway
```

### 2. Reactive Resume (Main Application)

**Service Type**: Node.js Application
**Access**: Public HTTPS
**Port**: 3000
**Build**: NX monorepo (client + server)
**Domain**: `<project-name>.up.railway.app` + custom domains

**Setup**:
1. Create new service: "New" → "GitHub Repo" → Connect your fork
2. Configure build and start commands
3. Add environment variables (see below)
4. Deploy

**Build Configuration**:
```yaml
Build Command: pnpm install && pnpm build
Start Command: pnpm start
Watch Paths: apps/**, libs/**, tools/prisma/**
```

**Required Environment Variables**:
```bash
# Node Environment
NODE_ENV=production
PORT=3000

# Public URLs
PUBLIC_URL=https://your-app.up.railway.app
STORAGE_URL=https://your-minio.up.railway.app/josh-reactive-resume

# Database (from PostgreSQL service)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# Authentication Secrets (generate with: openssl rand -base64 64)
ACCESS_TOKEN_SECRET=<your-secret>
REFRESH_TOKEN_SECRET=<your-secret>

# Chrome/Puppeteer (from Browserless service)
CHROME_URL=ws://browserless.railway.internal:3001
CHROME_TOKEN=<generate with: openssl rand -hex 32>
CHROME_PORT=3001

# MinIO Storage (from MinIO service)
STORAGE_ENDPOINT=minio.railway.internal
STORAGE_PORT=9000
STORAGE_BUCKET=josh-reactive-resume
STORAGE_ACCESS_KEY=minioadmin
STORAGE_SECRET_KEY=minioadmin123
STORAGE_USE_SSL=false
STORAGE_SKIP_BUCKET_CHECK=false

# Email (optional)
MAIL_FROM=noreply@yourdomain.com
SMTP_URL=smtp://username:password@smtp.provider.com:587

# OAuth (optional)
# GITHUB_CLIENT_ID=
# GITHUB_CLIENT_SECRET=
# GITHUB_CALLBACK_URL=https://your-app.up.railway.app/api/auth/github/callback

# GOOGLE_CLIENT_ID=
# GOOGLE_CLIENT_SECRET=
# GOOGLE_CALLBACK_URL=https://your-app.up.railway.app/api/auth/google/callback

# Feature Flags (optional)
DISABLE_SIGNUPS=false
DISABLE_EMAIL_AUTH=false
```

**Railway Service Variables** (use Railway references):
```bash
DATABASE_URL=${{Postgres.DATABASE_URL}}
CHROME_URL=ws://browserless.railway.internal:3001
STORAGE_ENDPOINT=minio.railway.internal
```

**Custom Domains**:
1. Go to service "Settings" → "Domains"
2. Click "Custom Domain"
3. Add your domain (e.g., `resume.yourdomain.com`)
4. Configure DNS: CNAME → `<your-app>.up.railway.app`
5. Update `PUBLIC_URL` environment variable to match custom domain

### 3. MinIO (Object Storage)

**Service Type**: Docker Container
**Access**: Public HTTPS (for file downloads), Internal (for API)
**Ports**: 9000 (API), 9001 (Console)
**Image**: `minio/minio:latest`

**Why MinIO?**: Cloudflare R2 doesn't support S3's `setBucketPolicy()` API, causing PDF download failures. MinIO provides full S3 compatibility with public bucket access.

**Setup**:
1. Create new service: "New" → "Empty Service"
2. Configure Docker deployment
3. Add environment variables
4. Add startup command
5. Configure public access

**Docker Configuration**:
```yaml
Image: minio/minio:latest
Start Command: minio server /data --console-address ":9001"
```

**Environment Variables**:
```bash
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin123
MINIO_BROWSER=on
```

**Port Configuration**:
```yaml
Exposed Ports:
  - 9000 (API) - Enable public access
  - 9001 (Console) - Enable public access
```

**Post-Deployment Setup**:

1. **Access MinIO Console**:
   - URL: `https://<your-minio-domain>.railway.app:9001`
   - Login: `minioadmin` / `minioadmin123`

2. **Create Bucket**:
   ```
   Bucket Name: josh-reactive-resume
   Region: us-east-1
   Versioning: Disabled
   Object Locking: Disabled
   ```

3. **Configure Public Access Policy**:

   Go to Administrator → Buckets → josh-reactive-resume → Access Policy

   Add this policy (or use MinIO Console UI to set "public" for downloads):
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": {"AWS": ["*"]},
         "Action": ["s3:GetObject"],
         "Resource": ["arn:aws:s3:::josh-reactive-resume/resumes/*"]
       },
       {
         "Effect": "Allow",
         "Principal": {"AWS": ["*"]},
         "Action": ["s3:GetObject"],
         "Resource": ["arn:aws:s3:::josh-reactive-resume/pictures/*"]
       },
       {
         "Effect": "Allow",
         "Principal": {"AWS": ["*"]},
         "Action": ["s3:GetObject"],
         "Resource": ["arn:aws:s3:::josh-reactive-resume/previews/*"]
       }
     ]
   }
   ```

4. **Verify Public Access**:
   - Upload test file via console
   - Try accessing: `https://<your-minio-domain>.railway.app/josh-reactive-resume/<file>`
   - Should download without authentication

**Important MinIO Notes**:
- Internal services use `minio.railway.internal:9000` (no SSL)
- Browsers access files via public HTTPS URL
- Bucket policy allows public read-only access for downloads
- Console is for administration only, not user-facing

See `.claude/MINIO_SETUP.md` for detailed MinIO configuration guide.

### 4. Browserless (Chrome for PDF Generation)

**Service Type**: Docker Container
**Access**: Private (Railway internal network only)
**Port**: 3001
**Image**: `browserless/chrome:latest`

**Setup**:
1. Create new service: "New" → "Empty Service"
2. Configure Docker deployment
3. Add environment variables
4. Deploy

**Docker Configuration**:
```yaml
Image: browserless/chrome:latest
Start Command: (default)
```

**Environment Variables**:
```bash
TOKEN=<same as CHROME_TOKEN in main app>
PORT=3001
MAX_CONCURRENT_SESSIONS=10
CONNECTION_TIMEOUT=60000
```

**Port Configuration**:
```yaml
Exposed Ports:
  - 3001 (internal only, no public access needed)
```

**Resource Recommendations**:
- Memory: 2GB minimum (PDF rendering is memory-intensive)
- CPU: Shared is usually sufficient

## Deployment Workflow

### Initial Deployment

1. **Fork Repository**:
   ```bash
   # Fork on GitHub
   # Clone locally
   git clone https://github.com/yourusername/Josh-Reactive-Resume.git
   cd Josh-Reactive-Resume
   ```

2. **Create Railway Project**:
   - Go to Railway dashboard
   - Click "New Project"
   - Name it (e.g., "Josh-Reactive-Resume")

3. **Add Services in Order**:

   **Step 1: PostgreSQL**
   - Add PostgreSQL database
   - Wait for provisioning

   **Step 2: MinIO**
   - Add empty service → Docker
   - Configure as documented above
   - Create bucket and set policy
   - Note the public URL

   **Step 3: Browserless**
   - Add empty service → Docker
   - Configure as documented above
   - Generate `TOKEN` with `openssl rand -hex 32`

   **Step 4: Main Application**
   - Connect GitHub repository
   - Configure build/start commands
   - Add all environment variables (use `${{Service.VAR}}` references)
   - Deploy

4. **Run Database Migrations**:
   ```bash
   # Option 1: Via Railway CLI
   railway run pnpm prisma:migrate:deploy

   # Option 2: Via one-time command in Railway dashboard
   # Go to service → "Settings" → "Deploy Command"
   # Add: pnpm prisma:migrate:deploy
   ```

5. **Verify Deployment**:
   - Check all services are running
   - Visit public URL
   - Test user registration
   - Create a resume
   - Generate PDF (tests Browserless + MinIO)
   - Download PDF (tests MinIO public access)

### Updates and Redeployment

**For Code Changes**:
```bash
# Local development
git add .
git commit -m "Your changes"
git push origin main

# Railway auto-deploys on push to main branch
# Or manually trigger: Railway dashboard → Service → "Deploy"
```

**For Database Schema Changes**:
```bash
# 1. Update schema
vim tools/prisma/schema.prisma

# 2. Create migration locally
pnpm prisma:migrate:dev --name your_migration_name

# 3. Commit migration files
git add tools/prisma/migrations/
git commit -m "Database migration: your_migration_name"
git push origin main

# 4. Railway will auto-run migrations on deploy via prebuild hook
# Or manually: railway run pnpm prisma:migrate:deploy
```

**For Environment Variable Changes**:
1. Railway dashboard → Service → "Variables"
2. Update variables
3. Service automatically restarts

## Railway-Specific Features Used

### Service References
Railway allows referencing environment variables from other services:
```bash
DATABASE_URL=${{Postgres.DATABASE_URL}}
```

### Internal Networking
Services communicate via Railway's private network:
```bash
minio.railway.internal:9000
browserless.railway.internal:3001
postgres.railway.internal:5432
```

### Automatic HTTPS
Railway provides automatic HTTPS for public services:
- No SSL certificate configuration needed
- Automatic renewal

### Environment-Based Deployments
Railway supports multiple environments (production, staging, etc.):
```bash
# Create staging environment
railway environment create staging
railway link <project-id> staging
```

## Cost Optimization

### Railway Pricing (as of 2024)
- **Hobby Plan**: $5/month + usage
- **Pro Plan**: $20/month + usage
- **Usage Charges**: Based on resource usage (RAM, CPU, network)

### Optimization Tips

1. **Resource Limits**:
   ```yaml
   # Set memory limits per service
   Main App: 1GB
   PostgreSQL: 512MB
   MinIO: 512MB
   Browserless: 2GB
   ```

2. **Sleep Inactive Services** (Hobby Plan):
   - Disable for production
   - Enable for development/staging

3. **CDN for Static Assets**:
   - Consider using Cloudflare CDN
   - Reduces Railway bandwidth usage

4. **Database Connection Pooling**:
   - Already handled by Prisma
   - No additional configuration needed

## Troubleshooting

### PDF Generation Fails
**Symptoms**: "Failed to generate PDF" errors

**Checks**:
1. Browserless service is running
2. `CHROME_URL` is correct: `ws://browserless.railway.internal:3001`
3. `CHROME_TOKEN` matches in both services
4. Browserless has enough memory (2GB minimum)

**Debug**:
```bash
# Check Browserless logs
railway logs --service browserless

# Test connection from main app
railway run curl http://browserless.railway.internal:3001
```

### PDF Download Fails
**Symptoms**: 404 or access denied when downloading PDFs

**Checks**:
1. MinIO service is running
2. Bucket `josh-reactive-resume` exists
3. Bucket policy is set to public for `/resumes/*`
4. `STORAGE_URL` points to public MinIO domain

**Debug**:
```bash
# Check MinIO logs
railway logs --service minio

# Verify bucket policy
# Access MinIO console: https://<minio-domain>.railway.app:9001
```

### Database Connection Errors
**Symptoms**: "Can't reach database server" errors

**Checks**:
1. PostgreSQL service is running
2. `DATABASE_URL` environment variable is correct
3. Migrations have been run

**Debug**:
```bash
# Check database status
railway run pnpm prisma db pull

# Run migrations
railway run pnpm prisma:migrate:deploy
```

### Custom Domain Not Working
**Symptoms**: Custom domain doesn't load or shows certificate errors

**Checks**:
1. DNS CNAME is correct and propagated
2. Domain added in Railway dashboard
3. `PUBLIC_URL` environment variable updated
4. SSL certificate issued (can take 5-10 minutes)

**Debug**:
```bash
# Check DNS propagation
dig resume.yourdomain.com

# Check SSL certificate
curl -vI https://resume.yourdomain.com
```

### Build Failures
**Symptoms**: Deployment fails during build

**Checks**:
1. Node.js version: Should use ≥22.13.1
2. Build command is correct
3. Dependencies are installed
4. No TypeScript errors

**Debug**:
```bash
# Check build logs in Railway dashboard
# Or test locally:
pnpm install
pnpm build
```

## Migration from Upstream

If you're migrating from the upstream Reactive Resume to this Railway-specific fork:

1. **Export Data**:
   - Export user data (if possible)
   - Document OAuth configurations
   - Note custom domains

2. **Deploy New Instance**:
   - Follow deployment steps above
   - Configure services

3. **Migrate Database**:
   ```bash
   # Dump from old database
   pg_dump $OLD_DATABASE_URL > backup.sql

   # Restore to new database
   psql $NEW_DATABASE_URL < backup.sql

   # Run new migrations
   pnpm prisma:migrate:deploy
   ```

4. **Migrate Storage**:
   ```bash
   # Use MinIO client to sync
   mc alias set old-storage <old-endpoint> <key> <secret>
   mc alias set new-storage https://<minio>.railway.app minioadmin minioadmin123
   mc mirror old-storage/bucket new-storage/josh-reactive-resume
   ```

5. **Update DNS**:
   - Point domains to new Railway deployment
   - Wait for propagation
   - Verify functionality

## Railway CLI Usage

Install Railway CLI for easier management:

```bash
# Install
npm install -g @railway/cli

# Login
railway login

# Link project
railway link <project-id>

# View logs
railway logs

# Run commands
railway run pnpm prisma:migrate:deploy

# SSH into service
railway shell

# Open dashboard
railway open
```

## Security Best Practices

1. **Rotate Secrets Regularly**:
   ```bash
   # Generate new secrets
   openssl rand -base64 64  # ACCESS_TOKEN_SECRET
   openssl rand -base64 64  # REFRESH_TOKEN_SECRET
   openssl rand -hex 32     # CHROME_TOKEN
   ```

2. **Use Strong MinIO Credentials**:
   - Change default `minioadmin` credentials
   - Use long, random passwords

3. **Enable Two-Factor Auth**:
   - For Railway account
   - For user accounts in the app

4. **Monitor Access Logs**:
   - Check Railway logs regularly
   - Set up log alerts for errors

5. **Keep Dependencies Updated**:
   ```bash
   pnpm update
   pnpm audit
   ```

6. **Database Backups**:
   - Railway provides automatic backups
   - Consider additional backup strategy for critical data

## Support and Resources

- **Railway Documentation**: https://docs.railway.app
- **Reactive Resume Docs**: https://docs.rxresu.me
- **This Fork's Documentation**: See `.claude/` directory
- **Railway Community**: https://discord.gg/railway
- **Issue Tracking**: File issues in your fork's GitHub repository

---

**Last Updated**: 2025-11-03
**Railway Platform Version**: Railway V2
**Reactive Resume Version**: 4.5.2 (forked)
